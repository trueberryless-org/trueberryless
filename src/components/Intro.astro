---
export const prerender = false;

import { Image } from "astro:assets";
import profilePicture from "../assets/profile-picture.png";

interface LanyardData {
  data: {
    discord_status: string;
  };
  success: boolean;
}

const statusColors = {
  online: "var(--ctp-green)",
  idle: "var(--ctp-yellow)",
  dnd: "var(--ctp-red)",
  offline: "var(--ctp-overlay0)",
  loading: "var(--ctp-surface1)",
};

const statusLabels = {
  online: "Online",
  idle: "Idle",
  dnd: "Do Not Disturb",
  offline: "Offline",
  loading: "Loading status",
};

let discordStatus: keyof typeof statusColors = "loading";

try {
  const response = await fetch(`${Astro.url.origin}/api/discord-activity.json`);
  if (response.ok) {
    const lanyardData: LanyardData = await response.json();
    discordStatus = lanyardData.data
      .discord_status as keyof typeof statusColors;
  } else {
    discordStatus = "offline";
  }
} catch (error) {
  console.error("Error fetching Discord status:", error);
  discordStatus = "offline";
}

const statusColor = statusColors[discordStatus] || statusColors.loading;
const statusLabel = statusLabels[discordStatus] || statusLabels.loading;
---

<section class="intro">
  <div class="content">
    <div class="pfp-container">
      <Image src={profilePicture} alt="trueberryless" class="pfp" />
      <div
        class={`status-indicator ${discordStatus}`}
        style={`background-color: ${statusColor}`}
        role="status"
        aria-label={`Discord status: ${statusLabel}`}
      >
      </div>
    </div>
    <div class="text">
      <h1>Hello, I'm Felix Schneider</h1>
      <p class="subtitle">also known as trueberryless everywhere online</p>
    </div>
  </div>
</section>

<style>
  .intro {
    padding: 8rem 2rem 6rem;
    display: flex;
    justify-content: center;
  }

  .content {
    max-width: 600px;
    width: 100%;
    display: flex;
    align-items: center;
    gap: 2rem;
  }

  .pfp-container {
    position: relative;
    flex-shrink: 0;
  }

  .pfp {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    border: 3px solid var(--ctp-lavender);
    transition:
      transform 0.3s ease,
      border-color 0.3s ease;
  }

  .pfp:hover {
    transform: scale(1.05);
    border-color: var(--ctp-pink);
  }

  .status-indicator {
    position: absolute;
    bottom: 4px;
    right: 4px;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    border: 5.5px solid var(--ctp-base);
    transition: background-color 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  /* === Specific Status Styles === */

  /* Online: solid circle (default look) */

  /* Idle: crescent moon shape (accurate Discord style) */
  .status-indicator.idle {
    background-color: var(--ctp-yellow);
  }
  .status-indicator.idle::after {
    content: "";
    position: absolute;
    top: -15%;
    right: 35%;
    width: 80%;
    height: 80%;
    background-color: var(--ctp-base);
    border-radius: 50%;
  }

  /* DND: white horizontal bar */
  .status-indicator.dnd::after {
    content: "";
    position: absolute;
    width: 60%;
    height: 4px;
    background-color: var(--ctp-base);
    border-radius: 2px;
  }

  /* Offline: hollow circle with background fill */
  .status-indicator.offline {
    background-color: var(--ctp-overlay0);
  }
  .status-indicator.offline::after {
    content: "";
    position: absolute;
    width: 55%;
    height: 55%;
    background-color: var(--ctp-base); /* matches page bg, hides pfp */
    border-radius: 50%;
  }

  /* Loading: pulsing grey */
  .status-indicator.loading {
    animation: pulse 1.2s infinite ease-in-out;
  }

  @keyframes pulse {
    0% {
      background-color: var(--ctp-surface1);
    }
    50% {
      background-color: var(--ctp-overlay1);
    }
    100% {
      background-color: var(--ctp-surface1);
    }
  }

  .text {
    flex: 1;
  }

  h1 {
    font-size: 2rem;
    font-weight: 600;
    color: var(--ctp-text);
    margin-bottom: 0.5rem;
  }

  .subtitle {
    font-size: 1rem;
    color: var(--ctp-subtext0);
    opacity: 0.8;
  }

  @media (max-width: 600px) {
    .intro {
      padding: 4rem 2rem 3rem;
    }

    .content {
      flex-direction: column;
      text-align: center;
    }

    .pfp {
      width: 100px;
      height: 100px;
    }

    .status-indicator {
      width: 20px;
      height: 20px;
      bottom: 2px;
      right: 2px;
    }

    h1 {
      font-size: 1.5rem;
    }
  }
</style>
